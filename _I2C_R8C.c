//*************************************************************************************************//
//*************************************************************************************************//
//----------------------------------------- SOFTWARE I2C ------------------------------------------//
//*************************************************************************************************//
//*************************************************************************************************//


//-------------------------------------------------------------------------------------------------//
//-------------------------------- Variables & Functions Declaration ------------------------------//
//-------------------------------------------------------------------------------------------------//

sbit SCL=P2^3;//p1_5//							// Port pin for SCL line
sbit SDA=P2^2;//p1_6//							// Port pin for SDA line

void i2c_delay(void);								// I2C Clock delay 
void i2c_start(void);								// Generates a I2C Start condition
void i2c_stop(void);								// Generates a I2C Stop condition
void i2c_wbyte(char i2c_wb);						// Writes a single byte from I2C Slave
unsigned char i2c_rbyte(void);						// Reads and returns a single byte from I2C Slave
char i2c_ack(void);									// I2C Acknowledge
void i2c_nack(void);								// I2C Not Acknowlegdge

void i2c_write(char id, char add,char dat);
unsigned char i2c_read(char id,char add);

//-------------------------------------------------------------------------------------------------//
//------------------------------------------ I2C DELAY --------------------------------------------//
//-------------------------------------------------------------------------------------------------//

void i2c_delay(void)
{
	char a;
	for(a=0;a<20;a++);
}

//-------------------------------------------------------------------------------------------------//
//------------------------------------------ I2C START --------------------------------------------//
//-------------------------------------------------------------------------------------------------//

void i2c_start(void)
{
//	SCL_Dir = 1;									// Set SCL pin as output
//	SDA_Dir = 1;									// Set SDA pin as output
	SCL = 1;
	i2c_delay();
	SDA	= 1;
	i2c_delay();
	SDA	= 0;
	i2c_delay();
	SCL = 0;		
	i2c_delay();	
}

//-------------------------------------------------------------------------------------------------//
//------------------------------------------- I2C STOP --------------------------------------------//
//-------------------------------------------------------------------------------------------------//

void i2c_stop(void)
{
	//SDA_Dir = 1;									// Set SDA pin as output
	SDA	= 0;
	i2c_delay();
	SCL	= 1;
	i2c_delay();
	SDA = 1;
	i2c_delay();//
	SCL = 0;	//		
}

//-------------------------------------------------------------------------------------------------//
//---------------------------------------- I2C WRITE BYTE -----------------------------------------//
//-------------------------------------------------------------------------------------------------//

void i2c_wbyte(unsigned char i2c_wb)
{
	char a;
	//DA_Dir = 1;									// Set SDA pin as output
	for(a=0;a<8;a++)								// Send 8 bits 
	{	
		SCL = 0;								
		i2c_delay();								
		if(i2c_wb & (0x80 >> a))
		{
			SDA = 1;								
		}
		else
		{
			SDA = 0;								
		}
		i2c_delay();				
		SCL	= 1;								
		i2c_delay();
	}	
}

//-------------------------------------------------------------------------------------------------//
//----------------------------------------- I2C READ BYTE -----------------------------------------//
//-------------------------------------------------------------------------------------------------//

unsigned char i2c_rbyte(void)
{
	char a;
	unsigned char b;
	b=0;
	//SDA_Dir = 0;									// Set SDA pin as input								
	for(a=0;a<8;a++)
	{
		SCL = 1;									
		i2c_delay();
		if(SDA)		
		{
			b |= (0x80 >> a);						// Set data bit on SDA line
		}
		i2c_delay();
		SCL	= 0;									
		i2c_delay();
	}
	return(b);
}

//-------------------------------------------------------------------------------------------------//
//-------------------------------------------- I2C ACK --------------------------------------------//
//-------------------------------------------------------------------------------------------------//

char i2c_ack(void)
{
	char a;
	//SDA_Dir = 1;									// Set SDA pin as output
	i2c_delay();
	SCL	= 0;
	i2c_delay();
	SDA	= 1;
	i2c_delay();
	SCL = 1;
	i2c_delay();
	//SDA_Dir = 0;									// Set SDA pin as input	
	i2c_delay();
	a = SDA;
	i2c_delay();
	SCL = 0;
	i2c_delay();
	return(a);
}

//-------------------------------------------------------------------------------------------------//
//------------------------------------------- I2C NACK --------------------------------------------//
//-------------------------------------------------------------------------------------------------//

void i2c_nack(void)
{
	//SDA_Dir = 1;									// Set SDA pin as output
	SDA	= 1;
	i2c_delay();
	SCL	= 1;
	i2c_delay();
	SCL = 0;
	i2c_delay();
}

//-------------------------------------------------------------------------------------------------//
//-------------------------------------------- I2C WRITE ------------------------------------------//
//-------------------------------------------------------------------------------------------------//

void i2c_write(unsigned char id, unsigned char add, unsigned char dat)
{
	i2c_start();
	i2c_wbyte(id);
	i2c_ack();
	i2c_wbyte(add);
	i2c_ack();
	i2c_wbyte(dat);
	i2c_ack();
	i2c_stop();	
}

//-------------------------------------------------------------------------------------------------//
//-------------------------------------------- I2C Read -------------------------------------------//
//-------------------------------------------------------------------------------------------------//

unsigned char i2c_read(unsigned char id,unsigned char add)
{
	unsigned char rd;
	i2c_start();
	i2c_wbyte(id);
	i2c_ack();
	i2c_wbyte(add);
	i2c_ack();
	i2c_start();
	i2c_wbyte((id|0x01));
	i2c_ack();
	rd = i2c_rbyte();
	i2c_nack();
	i2c_stop();
	return(rd);
}

//-------------------------------------------------------------------------------------------------//
//-------------------------------------------------------------------------------------------------//
//-------------------------------------------------------------------------------------------------//